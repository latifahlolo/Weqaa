import streamlit as st
import google.generativeai as genai
import json
import re  # ุงุณุชูุฑุงุฏ ููุชุจุฉ ุงูุชุนุจูุฑุงุช ุงูููุทูุฉ

# ๐ ุฅุนุฏุงุฏ ููุชุงุญ Google Gemini API
genai.configure(api_key="AIzaSyBdIOwS9L2zx090u7HI_i6JyDUPWP1OTvc")  # ุงุณุชุจุฏู ุจููุชุงุญู ุงูุตุญูุญ

def solve_database_issue(issue_description):
    """
    ๐ฏ ูุณุงุนุฏ ุดุฎุตู ูุญู ูุดุงูู ุงูููุธููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    """
    prompt = f"""
    ๐ฏ **ูููุชู ููุณุงุนุฏ ุฐูุงุก ุงุตุทูุงุนู:**
    ุฃูุช ูุณุงุนุฏ ููุธูู ูุฑูุฒ ููุงุก ูู ุญู ุงููุดุงูู ุงููุชุนููุฉ ุจูุงุนุฏุฉ ุงูุจูุงูุงุช. 

    โ **ูุตู ุงููุดููุฉ:**  
    {issue_description}
    
    ๐น **ุชุนูููุงุช ุตุงุฑูุฉ:**
    1๏ธโฃ **ุงููู ุงููุดููุฉ ุจุฏูุฉ ูุญุฏุฏ ุงูุณุจุจ ุงูุฃุณุงุณู ููุง.**  
    2๏ธโฃ **ูู ุจุชุญููู ุงููุดููุฉ ูุงูุชุฑุญ ุญูุงู ููุงุณุจูุง ูุชูุงุดู ูุน ุทุจูุนุฉ ุงูุฎุทุฃ ุฃู ุงูุญุงุฌุฉ.**  
    3๏ธโฃ **ูุฏู ูุตูุญุฉ ูุชุฌูุจ ุญุฏูุซ ุงููุดููุฉ ูุณุชูุจูุงู.**  
    4๏ธโฃ **ูู ุจุฅุถุงูุฉ ุฎุทูุงุช ุชูููุฐ ุงูุญู ุจุดูู ูุงุถุญ ูุจุชุฑุชูุจ ููุทูู ูุณุงุนุฏ ุงูููุธู ูู ุงูุญู.**  
    5๏ธโฃ **ูุง ุชูุฏู ุฃู ูุนูููุงุช ุบูุฑ ุฐุงุช ุตูุฉ. ูุฌุจ ุฃู ูููู ุงูุฅุฎุฑุงุฌ ุจุตูุบุฉ JSON ููุท.**
    
    ๐ **ูุซุงู ุนูู ุงูุฅุฎุฑุงุฌ ุงูุตุญูุญ:**  
    ```json
    {{
        "problem_analysis": "ุงููุดููุฉ ุชุชุนูู ุจุนุฏู ุงูุนุซูุฑ ุนูู ุญูู ูุนูู ูู ุงูุฌุฏุงููุ ููุฏ ูููู ุงูุณุจุจ ุฃู ุงูุญูู ุบูุฑ ููุฌูุฏ ุฃู ุฃู ููุงู ุฎุทุฃ ูู ุงูุงุณุชุนูุงู.",
        "suggested_solution": "ุชุญูู ูู ุฃุณูุงุก ุงูุญููู ุงููุชุงุญุฉ ูู ุงูุฌุฏุงูู ุนุจุฑ ูุญุต ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุฅุฐุง ูู ููู ุงูุญูู ููุฌูุฏูุงุ ููู ุจุฅุถุงูุชู.",
        "prevention_tip": "ุชุฃูุฏ ูู ุชูุซูู ุฃุณูุงุก ุงูุญููู ูู ูุณุชูุฏ ูุฑุฌุนูุ ูุชูุญูุฏ ุงูุชุณููุฉ ุนูุฏ ุฅูุดุงุก ุงูุฌุฏุงูู ูุชุฌูุจ ุงูุงูุชุจุงุณ.",
        "solution_steps": [
            "ุงูุชุญ ุฃุฏุงุฉ ุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุซู SQL Server Management Studio ุฃู phpMyAdmin).",
            "ูู ุจุชูููุฐ ุงูุงุณุชุนูุงู ุงูุชุงูู ููุชุญูู ูู ูุฌูุฏ ุงูุญูู: `SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ุงุณู_ุงูุฌุฏูู';`",
            "ุฅุฐุง ูู ููู ุงูุญูู ููุฌูุฏูุงุ ุงุณุชุฎุฏู ุงูุฃูุฑ ุงูุชุงูู ูุฅุถุงูุชู: `ALTER TABLE ุงุณู_ุงูุฌุฏูู ADD ุงุณู_ุงูุญูู ููุน_ุงูุจูุงูุงุช;`",
            "ุงุญูุธ ุงูุชุบููุฑุงุช ูุฃุนุฏ ุชุดุบูู ุฃู ุนูููุงุช ุชุนุชูุฏ ุนูู ูุฐุง ุงูุญูู ูุถูุงู ุนูููุง ุจุดูู ุตุญูุญ."
        ]
    }}
    ```

    โ **ูุง ุชุฎุฑุฌ ุฃู ุดูุก ุฎุงุฑุฌ JSON!**
    """

    try:
        model = genai.GenerativeModel("gemini-pro")

        response = model.generate_content(
            prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.2
            )
        )

        response_text = response.text.strip()

        # ๐ **ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ JSON ูู ุงููุต ุจุงุณุชุฎุฏุงู ุงูุชุนุจูุฑุงุช ุงูููุทูุฉ (Regex)**
        match = re.search(r'\{.*\}', response_text, re.DOTALL)
        if match:
            json_text = match.group(0)
            return json.loads(json_text)  # ุชุญููู ุงููุต ุฅูู JSON
        
        return {"error": "โ๏ธ ุงููููุฐุฌ ูู ูุฑุฌุน ุงุณุชุฌุงุจุฉ ุจุตูุบุฉ JSONุ ุญุงูู ูุฌุฏุฏูุง."}

    except Exception as e:
        return {"error": f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงููุดููุฉ: {str(e)}"}

# ๐ **ูุงุฌูุฉ Streamlit**
st.title("๐๏ธ ูุณุงุนุฏู ุงูุฐูู ูุญู ูุดุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")

st.write("๐ ุฃุฏุฎู ูุตู ุงููุดููุฉ ุงูุชู ุชูุงุฌููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุณูุณุงุนุฏู ูุณุงุนุฏู ุงูุฐูู ูู ุชูุฏูู ุญููู ุนูููุฉ ุจุฎุทูุงุช ุชูููุฐ ูุงุถุญุฉ")

# โ๏ธ ุฅุฏุฎุงู ูุตู ุงููุดููุฉ ูู ุงููุณุชุฎุฏู
issue_description = st.text_area("โ๏ธ ุฃุฏุฎู ุงููุดููุฉ ููุง:", height=150)

if st.button("๐ ุญู ุงููุดููุฉ"):
    if issue_description.strip():
        st.write("๐ **ุฌุงุฑู ุชุญููู ุงููุดููุฉ...**")

        result = solve_database_issue(issue_description)  # ุชุดุบูู ุชุญููู ุงููุดููุฉ

        # ๐ **ุนุฑุถ ุงููุชูุฌุฉ ุงูุฃูููุฉ ููุญุต ุฃู ุฎุทุฃ**
        st.write("๐ ุงููุชูุฌุฉ ุงูุฃูููุฉ:", result)

        st.subheader("๐น ุงูุญู ุงูููุชุฑุญ:")
        st.json(result)  # ุนุฑุถ ุงููุชูุฌุฉ ุจุตูุบุฉ JSON

        if "solution_steps" in result:
            st.subheader("๐ ุฎุทูุงุช ุงูุชูููุฐ:")
            for idx, step in enumerate(result["solution_steps"], 1):
                st.write(f"{idx}. {step}")
    else:
        st.warning("โ๏ธ ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ุงููุดููุฉ ูุจู ุทูุจ ุงูุญู!")
